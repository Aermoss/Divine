func printf(fmt: i8*, ...) -> i32;
func scanf(fmt: i8*, ...) -> i32;

func malloc(size: i64, ...) -> void*;
func free(ptr: void*, ...) -> void;
func memcpy(dst: void*, src: void*, size: i64, ...) -> void*;
func strlen(str: i8*, ...) -> i64;

func max(a: i64, b: i64) -> i64 {
    if a > b { ret a; }
    else { ret b; }
}

class String {
    priv data: i8* = null,
    priv size: i64 = 0
} impl {
    const() { this = "\0"; }
    dest() { Release(); }

    pub Data() -> i8* { ret data; }
    pub Size() -> i64 { ret size; }

    priv Allocate(newSize: i64) {
        (data, size) = (malloc(newSize), newSize);
    }

    priv Release() {
        if data != null { free(data); }
        (data, size) = (null, 0);
    }

    operator=(string: i8*) {
        if string == null { ret; }
        if data != null { free(data); }
        Allocate(strlen(string) + 1);
        memcpy(data, string, size);
    }

    operator+=(string: i8*) {
        if string == null { ret; }
        let (oldData: i8*, oldSize: i64) = (data, max(size - 1, 0));
        Allocate(oldSize + strlen(string) + 1);

        if oldData != null {
            memcpy(data, oldData, oldSize);
            free(oldData);
        }

        memcpy(data + oldSize, string, strlen(string) + 1);
    }
};

/* class Vector<T> {
    priv data: i8* = null,
    priv size: i64 = 0
} impl {
    const() {}
    dest() { Release(); }

    pub Data() -> i8* { ret data; }
    pub Size() -> i64 { ret size; }

    pub Allocate(size_: i64) {
        this->size = size_;
        data = malloc(sizeof(T) * size_);
    }

    pub Release() {
        if data != null { free(data); }
        (data, size) = (null, 0);
    }

    pub PushBack(value: T) {
        void* temp = data;
        this->Allocate(size + 1);

        if temp != null {
            memcpy(data, temp, sizeof(T) * (size - 1));
        }

        free(temp);
        data[size - 1] = value;
    }

    pub PopBack() -> T {
        void* temp = data;
        this->Allocate(size - 1);
        let value: T = temp[size];

        if temp != null {
            memcpy(data, temp, sizeof(T) * size);
        }

        free(temp);
        ret value;
    }
}; */

func main(argc: i32, argv: [i8*]) -> i32 {
    let str: String;
    let a: i32 = 32;
    let b: i32 = 12;
    let c: i32 = a + b;
    a = 55;

    for let i: i32 = 0; i < 10; i = i + 1 {
        printf("%d\n", i);
    }

    printf("Hello, World! %d + %d = %d\n", a, b, c);

    printf("size = %d, data = %s\n", str.Size(), str.Data());
    str = "Hello, World!";
    printf("size = %d, data = %s\n", str.Size(), str.Data());
    str += "\nGoodbye, World!";
    printf("size = %d, data = %s\n", str.Size(), str.Data());


    /* let vec: Vector<i32>;
    vec.PushBack(1);

    printf("size = %d, data = %d\n", vec.Size(), vec.Data()); */

    ret 0;
}