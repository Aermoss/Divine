# LLVM IR Comparison Analysis - README

This directory contains a comprehensive analysis comparing two LLVM IR files from the Divine compiler project:
- **main.llvm** - Working version (generated by older compiler)
- **_main.ll** - Failing version (generated by current compiler)

## ğŸ“š Documentation Files

### 1. [QUICK_SUMMARY.md](QUICK_SUMMARY.md)
**Start here!** A brief 2-minute read explaining the core problem.
- The problem in 3 sentences
- Visual comparison
- Impact explanation
- Quick fix overview

### 2. [VISUAL_COMPARISON.md](VISUAL_COMPARISON.md)
Side-by-side comparison with diagrams showing:
- Struct layout differences
- Memory visualization  
- Feature comparison tables
- The core problem illustrated

### 3. [LLVM_IR_ANALYSIS_REPORT.md](LLVM_IR_ANALYSIS_REPORT.md)
Complete technical analysis including:
- Detailed root cause analysis
- Code examples (before/after)
- Step-by-step fix recommendations
- Verification procedures
- Testing strategies

## ğŸ¯ TL;DR - The Problem

```llvm
# Working (main.llvm):
%"Token" = type <{i32, [4 x i8], %"String", i64, i64}>
                  ^^^^^^^^^^^
                  Packed struct with explicit padding

# Failing (_main.ll):
%Token = type { i32, %String, i64, i64 }
              ^                      ^
              Unpacked - LLVM adds padding
              â†’ Wrong offsets â†’ Crashes
```

## ğŸ”§ The Fix

In the Divine compiler's LLVM IR emission:

```python
# Change struct definitions from:
def emit_struct_unpacked(self, fields):
    return f"%{name} = type {{ {fields} }}"

# To:
def emit_struct_packed(self, fields_with_padding):
    return f"%{name} = type <{{ {fields_with_padding} }}>"
```

## ğŸ“Š Impact Summary

| Severity | Issue | Count |
|----------|-------|-------|
| ğŸ”´ CRITICAL | Struct packing mismatch | 27+ types |
| ğŸ”´ CRITICAL | Data layout incompatibility | 1 |
| ğŸŸ¡ MEDIUM | GEP modifier differences | 10,000+ ops |
| ğŸŸ¢ LOW | Type name syntax | Cosmetic |

## ğŸš€ Quick Navigation

**Just want to understand the problem?**
â†’ Read [QUICK_SUMMARY.md](QUICK_SUMMARY.md)

**Want to see visual comparisons?**
â†’ Read [VISUAL_COMPARISON.md](VISUAL_COMPARISON.md)

**Need to implement the fix?**
â†’ Read [LLVM_IR_ANALYSIS_REPORT.md](LLVM_IR_ANALYSIS_REPORT.md) â†’ Section "Recommendations"

**Want to verify the fix works?**
â†’ Read [LLVM_IR_ANALYSIS_REPORT.md](LLVM_IR_ANALYSIS_REPORT.md) â†’ Section "Verification Checklist"

## ğŸ” Analysis Methodology

The analysis was performed using:
1. **Automated parsing** - Python scripts to extract and compare IR features
2. **Manual inspection** - Detailed examination of struct definitions
3. **Cross-referencing** - Comparison with source files (main.div, _main.div)
4. **LLVM semantics** - Review of LLVM Language Reference documentation

## ğŸ“ˆ Statistics

- **Files analyzed:** 2 LLVM IR files (115,063 total lines)
- **Structs compared:** 90+ type definitions
- **Issues identified:** 4 categories (2 critical, 1 medium, 1 low)
- **Root cause:** Packed vs unpacked struct syntax
- **Estimated fix time:** 1-2 hours

## âœ… Verification After Fix

After implementing the fix, verify:

```bash
# 1. Compare struct definitions
diff <(grep "type <{" main.llvm | head) \
     <(grep "type <{" _main.ll | head)
# Should show matching packed syntax

# 2. Validate IR
llvm-as _main.ll -o _main.bc
# Should compile without errors

# 3. Test runtime behavior
clang _main.ll -o test_program
./test_program test_input.div
# Should not crash
```

## ğŸ“ Files in This Repository

```
.
â”œâ”€â”€ README.md                       # This file
â”œâ”€â”€ QUICK_SUMMARY.md               # 3KB - Quick overview
â”œâ”€â”€ VISUAL_COMPARISON.md           # 9KB - Visual diagrams
â”œâ”€â”€ LLVM_IR_ANALYSIS_REPORT.md    # 14KB - Complete technical report
â”œâ”€â”€ main.llvm                      # 57,286 lines - Working IR
â”œâ”€â”€ _main.ll                       # 57,777 lines - Failing IR
â”œâ”€â”€ main.div                       # Source file for main.llvm
â””â”€â”€ _main.div                      # Source file for _main.ll
```

## ğŸ¤ Contributing

If you're fixing this issue in the Divine compiler:

1. Read [LLVM_IR_ANALYSIS_REPORT.md](LLVM_IR_ANALYSIS_REPORT.md)
2. Implement the packed struct emission
3. Test with the verification procedures
4. Compare output with main.llvm to ensure compatibility

## ğŸ“š References

- [LLVM Language Reference - Structure Types](https://llvm.org/docs/LangRef.html#structure-type)
- [LLVM Data Layout](https://llvm.org/docs/LangRef.html#data-layout)
- [LLVM GetElementPtr](https://llvm.org/docs/GetElementPtr.html)

## ğŸ“§ Questions?

Refer to the detailed documentation files above. The analysis is comprehensive and should answer most questions about:
- Why the failure occurs
- What causes the differences
- How to fix the issue
- How to verify the fix works

---

**Analysis Date:** 2025-11-06  
**Repository:** [Aermoss/Divine](https://github.com/Aermoss/Divine)  
**Issue:** _main.ll fails while main.llvm works fine
